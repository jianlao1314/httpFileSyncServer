<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>æ–‡ä»¶æœåŠ¡</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding: 10px;
        background-color: #f5f5f5;
        margin: 0;
        font-size: 16px; /* å¢åŠ åŸºç¡€å­—ä½“å¤§å° */
      }
      .container {
        max-width: 100%;
        margin: 0 auto;
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .title {
        font-size: 20px;
        font-weight: 500;
        color: #333;
      }
      .upload-section {
        margin-bottom: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }
      .button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        min-width: 100px;
        margin: 5px;
      }
      .button:hover {
        background-color: #0056b3;
      }
      .button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .file-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
      }
      .file-item:hover {
        background-color: #f8f9fa;
      }
      .file-item:last-child {
        border-bottom: none;
      }
      .file-name {
        flex: 1;
        margin-right: 10px;
        cursor: pointer;
        color: #007bff;
        font-size: 16px;
        word-break: break-all;
      }
      .file-name:hover {
        text-decoration: underline;
      }
      .file-size {
        color: #666;
        margin-right: 10px;
        font-size: 14px;
        white-space: nowrap;
      }
      .file-date {
        color: #666;
        margin-right: 10px;
        font-size: 14px;
        display: none; /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šéšè—æ—¥æœŸ */
      }
      .progress-bar {
        width: 100%;
        height: 6px;
        background-color: #f0f0f0;
        border-radius: 3px;
        margin-top: 10px;
        display: none;
        position: relative;
      }
      .progress {
        width: 0%;
        height: 100%;
        background-color: #28a745;
        border-radius: 3px;
        transition: width 0.3s ease;
      }
      .breadcrumb {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
        font-size: 14px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .breadcrumb-item {
        color: #007bff;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
        white-space: nowrap;
      }
      .breadcrumb-item:hover {
        background-color: #e9ecef;
        text-decoration: none;
      }
      .breadcrumb-separator {
        color: #666;
      }
      .directory-icon {
        margin-right: 8px;
        font-size: 1.2em;
      }
      .directory-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .directory-item:hover {
        background-color: #e9ecef;
      }
      .file-item-container {
        display: flex;
        align-items: center;
        padding: 12px;
        background-color: white;
        border-radius: 4px;
        margin-bottom: 4px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .file-item-container:hover {
        background-color: #f8f9fa;
      }
      .download-button {
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
      }
      .download-button:hover {
        background-color: #218838;
      }
      .language-selector {
        margin-left: 10px;
      }
      .language-selector select {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background-color: white;
        cursor: pointer;
        font-size: 16px;
      }
      .header-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .speed-display {
        position: absolute;
        right: 0;
        top: -20px;
        color: #666;
        font-size: 14px;
        font-weight: 500;
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
      }

      /* ç§»åŠ¨è®¾å¤‡é€‚é… */
      @media (max-width: 768px) {
        body {
          padding: 5px;
          font-size: 16px;
        }
        .container {
          padding: 10px;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-controls {
          width: 100%;
          justify-content: space-between;
          margin-top: 10px;
        }
        .button {
          padding: 12px 20px;
          font-size: 16px;
          width: 100%;
          margin: 5px 0;
        }
        .file-item-container {
          flex-direction: column;
          align-items: flex-start;
        }
        .file-name {
          width: 100%;
          margin-bottom: 5px;
        }
        .file-size {
          margin-right: 0;
        }
        .download-button {
          width: 100%;
          text-align: center;
        }
        .breadcrumb {
          font-size: 12px;
        }
        .breadcrumb-item {
          padding: 2px 4px;
        }
      }

      /* å°å±å¹•è®¾å¤‡é€‚é… */
      @media (max-width: 480px) {
        .title {
          font-size: 18px;
        }
        .file-name {
          font-size: 14px;
        }
        .file-size {
          font-size: 12px;
        }
        .download-button {
          padding: 6px 12px;
          font-size: 12px;
        }
        .language-selector select {
          padding: 6px 10px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="title">æ–‡ä»¶æœåŠ¡</div>
        <div class="header-controls">
          <select class="language-selector" id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
          </select>
          <button class="button" id="settingsButton" onclick="window.location.href='settings.html'" style="display: none;">è®¾ç½®</button>
        </div>
      </div>

      <div class="breadcrumb" id="breadcrumb">
        <!-- é¢åŒ…å±‘å¯¼èˆªå°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
      </div>

      <div class="upload-section">
        <input type="file" id="fileInput" style="display: none">
        <button class="button" onclick="document.getElementById('fileInput').click()" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
        <button class="button" id="uploadButton" onclick="uploadFile()" disabled id="uploadBtn">ä¸Šä¼ </button>
        <div class="progress-bar" id="progressBar">
          <div class="progress" id="progress"></div>
        </div>
      </div>

      <ul class="file-list" id="fileList">
        <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
      </ul>
    </div>

    <script>
      let currentPath = '';
      let selectedFile = null;
      let currentLanguage = localStorage.getItem('language') || 'zh';
      let currentFiles = []; // æ·»åŠ å½“å‰æ–‡ä»¶åˆ—è¡¨å˜é‡
      let retryCount = 0;
      const maxRetries = 5;

      // æ£€æŸ¥æ˜¯å¦åœ¨ Electron ç¯å¢ƒä¸­
      const isElectron = window && window.process && window.process.type;

      // è¯­è¨€é…ç½®
      const translations = {
        zh: {
          title: 'æ–‡ä»¶æœåŠ¡',
          settings: 'è®¾ç½®',
          root: 'æ ¹ç›®å½•',
          selectFile: 'é€‰æ‹©æ–‡ä»¶',
          upload: 'ä¸Šä¼ ',
          download: 'ä¸‹è½½',
          fileSize: 'å¤§å°',
          modifiedDate: 'ä¿®æ”¹æ—¶é—´',
          uploadSuccess: 'ä¸Šä¼ æˆåŠŸ',
          uploadFailed: 'ä¸Šä¼ å¤±è´¥',
          fetchFailed: 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥'
        },
        en: {
          title: 'File Service',
          settings: 'Settings',
          root: 'Root',
          selectFile: 'Select File',
          upload: 'Upload',
          download: 'Download',
          fileSize: 'Size',
          modifiedDate: 'Modified',
          uploadSuccess: 'Upload successful',
          uploadFailed: 'Upload failed',
          fetchFailed: 'Failed to fetch file list'
        }
      };

      // æ›´æ–°ç•Œé¢è¯­è¨€
      function updateLanguage(lang) {
        // æ›´æ–°æ ‡é¢˜
        const titleElement = document.querySelector('.title');
        if (titleElement) {
          titleElement.textContent = translations[lang].title;
        }

        // æ›´æ–°è®¾ç½®æŒ‰é’®
        const settingsButton = document.getElementById('settingsButton');
        if (settingsButton) {
          settingsButton.textContent = translations[lang].settings;
        }

        // æ›´æ–°é€‰æ‹©æ–‡ä»¶æŒ‰é’®
        const selectFileBtn = document.getElementById('selectFileBtn');
        if (selectFileBtn) {
          selectFileBtn.textContent = translations[lang].selectFile;
        }

        // æ›´æ–°ä¸Šä¼ æŒ‰é’®
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
          uploadBtn.textContent = translations[lang].upload;
        }
      }

      // åˆ‡æ¢è¯­è¨€
      function changeLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        updateLanguage(lang);
        updateBreadcrumb(currentPath);
        displayFiles(currentFiles);
      }

      // è·å–å½“å‰ä¸»æœºåœ°å€
      function getCurrentHost() {
        return window.location.origin;
      }

      // è·å–æ–‡ä»¶åˆ—è¡¨
      async function fetchFiles(path = '') {
        try {
          const response = await fetch(`${getCurrentHost()}/api/files?path=${encodeURIComponent(path)}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          currentPath = data.currentPath;
          currentFiles = data.files; // ä¿å­˜å½“å‰æ–‡ä»¶åˆ—è¡¨
          updateBreadcrumb(data.currentPath);
          displayFiles(data.files);
          retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
        } catch (error) {
          console.error(translations[currentLanguage].fetchFailed, error);
          if (retryCount < maxRetries) {
            retryCount++;
            console.log(`é‡è¯•è·å–æ–‡ä»¶åˆ—è¡¨ (${retryCount}/${maxRetries})...`);
            setTimeout(() => {
              fetchFiles(path).catch(console.error);
            }, 1000 * retryCount); // é€’å¢é‡è¯•å»¶è¿Ÿ
          } else {
            console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
            const fileList = document.getElementById('fileList');
            if (fileList) {
              fileList.innerHTML = `
                <li class="file-item">
                  <div class="file-item-container">
                    <span style="color: #dc3545;">${translations[currentLanguage].fetchFailed}</span>
                  </div>
                </li>
              `;
            }
          }
        }
      }

      // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
      function updateBreadcrumb(path) {
        const breadcrumb = document.getElementById('breadcrumb');
        const parts = path.split('/').filter(part => part);
        
        let html = `<span class="breadcrumb-item" onclick="navigateTo('')">${translations[currentLanguage].root}</span>`;
        let currentPath = '';
        
        parts.forEach((part, index) => {
          currentPath += '/' + part;
          html += `<span class="breadcrumb-separator">/</span>`;
          html += `<span class="breadcrumb-item" onclick="navigateTo('${currentPath}')">${part}</span>`;
        });
        
        breadcrumb.innerHTML = html;
      }

      // å¯¼èˆªåˆ°æŒ‡å®šç›®å½•
      function navigateTo(path) {
        fetchFiles(path);
      }

      // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
      function displayFiles(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        if (!files || files.length === 0) {
          return;
        }

        files.forEach(file => {
          const item = document.createElement('li');
          item.className = 'file-item';
          
          if (file.isDirectory) {
            item.innerHTML = `
              <div class="directory-item" onclick="navigateTo('${file.path}')">
                <span class="directory-icon">ğŸ“</span>
                <span class="file-name">${file.name}</span>
              </div>
            `;
          } else {
            item.innerHTML = `
              <div class="file-item-container">
                <span class="file-name">${file.name}</span>
                <span class="file-size">${translations[currentLanguage].fileSize}: ${formatFileSize(file.size)}</span>
                <span class="file-date">${translations[currentLanguage].modifiedDate}: ${formatDate(file.modified)}</span>
                <button class="download-button" onclick="downloadFile('${file.path}')">${translations[currentLanguage].download}</button>
              </div>
            `;
          }
          
          fileList.appendChild(item);
        });
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // æ ¼å¼åŒ–æ—¥æœŸ
      function formatDate(date) {
        return new Date(date).toLocaleString();
      }

      // é€‰æ‹©æ–‡ä»¶
      document.getElementById('fileInput').addEventListener('change', (event) => {
        selectedFile = event.target.files[0];
        document.getElementById('uploadButton').disabled = !selectedFile;
      });

      // ä¸Šä¼ æ–‡ä»¶
      async function uploadFile() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('targetDir', currentPath);
        
        // ç¡®ä¿å½“å‰è·¯å¾„æ­£ç¡®ä¼ é€’
        const targetDir = currentPath || '';
        
        console.log('å½“å‰æµè§ˆç›®å½•:', currentPath); // æ·»åŠ æ—¥å¿—
        console.log('ä¸Šä¼ åˆ°ç›®å½•:', targetDir); // æ·»åŠ æ—¥å¿—

        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const uploadButton = document.getElementById('uploadButton');
        const speedDisplay = document.createElement('div');
        speedDisplay.className = 'speed-display';
        progressBar.appendChild(speedDisplay);
        
        progressBar.style.display = 'block';
        uploadButton.disabled = true;

        try {
          // åˆ›å»º XMLHttpRequest å¯¹è±¡æ¥å¤„ç†ä¸Šä¼ 
          const xhr = new XMLHttpRequest();
          
          // è®¾ç½®ä¸Šä¼ è¿›åº¦å¤„ç†
          let lastLoaded = 0;
          let lastTime = Date.now();
          
          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percentComplete = (event.loaded / event.total) * 100;
              progress.style.width = percentComplete + '%';
              
              // è®¡ç®—ä¸Šä¼ é€Ÿåº¦
              const currentTime = Date.now();
              const timeDiff = (currentTime - lastTime) / 1000; // è½¬æ¢ä¸ºç§’
              const loadedDiff = event.loaded - lastLoaded;
              const speed = (loadedDiff / timeDiff / 1024 / 1024).toFixed(2); // è½¬æ¢ä¸º MB/s
              
              speedDisplay.textContent = `${speed} MB/s`;
              
              lastLoaded = event.loaded;
              lastTime = currentTime;
            }
          };

          // åˆ›å»º Promise æ¥å¤„ç†ä¸Šä¼ 
          const uploadPromise = new Promise((resolve, reject) => {
            xhr.onload = () => {
              if (xhr.status >= 200 && xhr.status < 300) {
                resolve(JSON.parse(xhr.responseText));
              } else {
                reject(new Error(`ä¸Šä¼ å¤±è´¥: ${xhr.status}`));
              }
            };
            xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'));
            xhr.onabort = () => reject(new Error('ä¸Šä¼ è¢«å–æ¶ˆ'));
          });

          // å¼€å§‹ä¸Šä¼ 
          xhr.open('POST', `${getCurrentHost()}/api/upload`, true);
          xhr.setRequestHeader('X-Target-Dir', encodeURIComponent(targetDir));
          xhr.send(formData);

          // ç­‰å¾…ä¸Šä¼ å®Œæˆ
          const result = await uploadPromise;
          console.log('ä¸Šä¼ æˆåŠŸ:', result);

          // ä¸Šä¼ æˆåŠŸ
          progress.style.width = '100%';
          setTimeout(() => {
            progressBar.style.display = 'none';
            progress.style.width = '0%';
            speedDisplay.remove();
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            // åˆ·æ–°å½“å‰ç›®å½•çš„æ–‡ä»¶åˆ—è¡¨
            fetchFiles(currentPath);
          }, 500);

        } catch (error) {
          console.error(translations[currentLanguage].uploadFailed, error);
          progressBar.style.display = 'none';
          speedDisplay.remove();
          uploadButton.disabled = false;
          
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
          const fileList = document.getElementById('fileList');
          if (fileList) {
            const errorItem = document.createElement('li');
            errorItem.className = 'file-item';
            errorItem.innerHTML = `
              <div class="file-item-container">
                <span style="color: #dc3545;">${translations[currentLanguage].uploadFailed}: ${error.message}</span>
              </div>
            `;
            fileList.insertBefore(errorItem, fileList.firstChild);
            
            // 3ç§’åç§»é™¤é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
              errorItem.remove();
            }, 3000);
          }
        }
      }

      // ä¸‹è½½æ–‡ä»¶
      function downloadFile(path) {
        window.location.href = `${getCurrentHost()}/api/download/${encodeURIComponent(path)}`;
      }

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', () => {
        // é‡ç½®é‡è¯•è®¡æ•°
        retryCount = 0;
        
        // è®¾ç½®å½“å‰è¯­è¨€
        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect) {
          languageSelect.value = currentLanguage;
        }
        
        // åªåœ¨ Electron ç¯å¢ƒä¸­æ˜¾ç¤ºè®¾ç½®æŒ‰é’®
        if (isElectron) {
          const settingsButton = document.getElementById('settingsButton');
          if (settingsButton) {
            settingsButton.style.display = 'block';
          }
        }
        
        updateLanguage(currentLanguage);
        
        // ç«‹å³è·å–æ–‡ä»¶åˆ—è¡¨
        fetchFiles().catch(error => {
          console.error('åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        });
      });
    </script>
  </body>
</html> 